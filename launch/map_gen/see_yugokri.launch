<?xml version="1.0" encoding="UTF-8"?>

<launch>


    <arg name="bag" default="true"/>
    <arg name = "bagfile" default="/media/jbs/ssd/atypical/KIAPI_0924/daegu_yugokri_result.bag"/>
    <param name="/use_sim_time" value="$(arg bag)"/>
    <node pkg="rosbag" type="play" name="rosbag_record_diag"
          args="--clock --loop -s 0 -r 2.0 $(arg bagfile)" if = "$(arg bag)"/>
<!--        <remap from = "/current_pose_cov" to = "/current_pose"/>-->


    <node pkg="pcl_ros" type="pcd_to_pointcloud" name="pcd_publisher"
          args="$(find atypical_driving)/worlds/yugokri_hd/yugokri_hd_SNU_frame.pcd 0.2 _frame_id:=SNU">
        <remap from="cloud_pcd" to="/rtabmap/cloud_map"/>
    </node>

    <!--3. client-->
    <node pkg="atypical_driving" type="keti_client" name="atypical_driving_client" output="screen">
        <param name="rejection_radius" value="1.6"/>
    </node>


    <arg name = "param_file" default = "yugokri.yaml"/>
    <arg name = "goal/x"  default = "323891.02"/> <!--in world frame -->
    <arg name = "goal/y" default = "4145172.15"/> <!--in world frame -->

    <!-- Arguments Start -->
    <arg name = "pcl_topic" default = "/atypical_planning_test/pcl_filtered"/>
    <arg name ="snu_frame_id" default="SNU"/>
    <arg name ="occu_frame_id" default="SNU"/>
    <arg name ="world_frame_id" default="map"/>
    <arg name ="car_base_frame_id" default="base_link"/>
    <arg name ="lidar_frame_id" default = "velodyne"/>
    <arg name ="detected_object_frame_id" default = "velodyne"/>


    <node pkg="tf" type="static_transform_publisher" name="link2lidar" args="-1.0.0 0 0.2 0 0 0  $(arg car_base_frame_id) $(arg lidar_frame_id) 10"/>

    <arg name = "lane_width" default="4.5"/>
    <arg name = "lane_csv_file" default = "$(find atypical_driving)/lane/interpolated_yugokri_path1.csv"/>
    <arg name = "log_file_prefix" default= "$(find atypical_driving)/log/log" />

    <node pkg="atypical_driving" type="mapper" name="atypical_planning_test" output="screen">
        <!--This shit could be here not outside with separate group ns-->
        <rosparam file="$(find atypical_driving)/param/MPC_weight.yaml"/>
        <param name = "lane_csv_file" value = "$(arg lane_csv_file)"/>
        <param name = "lane_width" value="$(arg lane_width)"/>
        <param name = "log_file_prefix" value = "$(arg log_file_prefix)" />

        <remap from = "/occupancy_grid" to = "/costmap_node/costmap/costmap"/>
        <remap from = "/current_pose" to = "/current_pose_cov"/>
        <remap from = "/vehicle_cmd" to = "/vehicle_cmd_snu"/>

        <param name = "world_frame_id" value="$(arg world_frame_id)" />
        <param name = "snu_frame_id" value="$(arg snu_frame_id)" />
        <param name = "occu_map_frame_id" value="$(arg occu_frame_id)" />
        <param name = "base_link_id" value="$(arg car_base_frame_id)" />
        <param name = "detected_objects_id" value="$(arg detected_object_frame_id)" />

        <rosparam command="load" file="$(find atypical_driving)/param/$(arg param_file)"/>

    </node>




    <node pkg="rviz" type="rviz" name="rviz" args="-d $(find atypical_driving)/launch/rviz_config/config.rviz" output="log" />

</launch>
